name: ML Model CI/CD

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'src/**'
      - 'configs/**'
      - 'data/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/ml-cicd.yml'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'src/**'
      - 'configs/**'
      - 'data/**'
      - 'tests/**'
      - 'requirements.txt'
      - '.github/workflows/ml-cicd.yml'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit
          pip install -r requirements.txt

      - name: Code formatting check (Black)
        run: |
          black --check --diff src/ tests/ train_pipeline.py

      - name: Import sorting check (isort)
        run: |
          isort --check-only --diff src/ tests/ train_pipeline.py

      - name: Lint with flake8
        run: |
          flake8 src/ tests/ train_pipeline.py --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 src/ tests/ train_pipeline.py --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics

      - name: Type checking (mypy)
        run: |
          mypy src/ --ignore-missing-imports

      - name: Security check (bandit)
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ --severity-level high

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ¢ãƒ‡ãƒ«è¨“ç·´å‰ã®åŸºæœ¬ãƒ†ã‚¹ãƒˆï¼‰
  test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r requirements.txt

      - name: Run basic tests (without model files)
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=html -k "not test_model_files_exist and not test_model_can_load and not test_model_can_predict"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # ãƒ¢ãƒ‡ãƒ«è¨“ç·´
  train-model:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p data/processed
          mkdir -p models/trained

      - name: Run ML pipeline
        run: |
          python train_pipeline.py

      - name: Verify model artifacts
        run: |
          ls -la models/trained/
          python -c "
          import joblib
          model = joblib.load('models/trained/house_price_prediction.pkl')
          preprocessor = joblib.load('models/trained/preprocessor.pkl')
          print('âœ… ãƒ¢ãƒ‡ãƒ«ã¨å‰å‡¦ç†å™¨ã®èª­ã¿è¾¼ã¿æˆåŠŸ')
          "

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-models
          path: |
            models/trained/house_price_prediction.pkl
            models/trained/preprocessor.pkl
          retention-days: 30

      - name: Upload processed data
        uses: actions/upload-artifact@v4
        with:
          name: processed-data
          path: data/processed/
          retention-days: 30

  # ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ãƒ†ã‚¹ãƒˆ
  model-performance:
    runs-on: ubuntu-latest
    needs: train-model
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/trained/

      - name: Download processed data
        uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: data/processed/

      - name: Run model performance tests
        run: |
          python -m pytest tests/test_model_pipeline.py::TestModelPipeline::test_model_files_exist -v
          python -m pytest tests/test_model_pipeline.py::TestModelPipeline::test_model_can_load -v
          python -m pytest tests/test_model_pipeline.py::TestModelPipeline::test_model_can_predict -v

      - name: Model performance summary
        run: |
          echo "ğŸ¯ ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Œäº†"
          echo "ğŸ“Š ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh models/trained/house_price_prediction.pkl | awk '{print $5}')"
          echo "ğŸ“Š å‰å‡¦ç†å™¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh models/trained/preprocessor.pkl | awk '{print $5}')"

  # GitHub Releaseä½œæˆï¼ˆã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ï¼‰
  create-release:
    runs-on: ubuntu-latest
    needs: [train-model, model-performance]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-models
          path: models/trained/

      - name: Download processed data
        uses: actions/download-artifact@v4
        with:
          name: processed-data
          path: data/processed/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            models/trained/house_price_prediction.pkl
            models/trained/preprocessor.pkl
            data/processed/featured_house_data.csv
          body: |
            ## ğŸ  House Price Prediction Model Release
            
            ### ğŸ“¦ å«ã¾ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
            - `house_price_prediction.pkl`: å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
            - `preprocessor.pkl`: å‰å‡¦ç†å™¨
            - `featured_house_data.csv`: å‡¦ç†æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            ```python
            import joblib
            
            # ãƒ¢ãƒ‡ãƒ«ã¨å‰å‡¦ç†å™¨ã‚’èª­ã¿è¾¼ã¿
            model = joblib.load('house_price_prediction.pkl')
            preprocessor = joblib.load('preprocessor.pkl')
            
            # äºˆæ¸¬å®Ÿè¡Œ
            # (ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§å‰å‡¦ç† â†’ äºˆæ¸¬)
            ```
            
            ### ğŸ“Š ãƒ¢ãƒ‡ãƒ«æƒ…å ±
            - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : Random Forest
            - ç‰¹å¾´é‡: sqft, bedrooms, bathrooms, year_built, location, condition
            - ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: house price
            
            ### ğŸ”„ CI/CD
            ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯è‡ªå‹•CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚Šç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 